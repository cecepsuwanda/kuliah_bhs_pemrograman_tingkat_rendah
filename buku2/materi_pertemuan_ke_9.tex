\chapter{Instruksi Stack: PUSH, POP, CALL, RET; Subrutin dan Parameter Sederhana}

\section{Tujuan Pembelajaran}
Mahasiswa mampu:
\begin{itemize}
  \item Menjelaskan konsep tumpukan (stack), prinsip LIFO, serta peran \texttt{SS:SP}.
  \item Menggunakan instruksi \texttt{PUSH}/\texttt{POP} pada register dan memori dengan aman.
  \item Memanggil dan kembali dari subrutin menggunakan \texttt{CALL}/\texttt{RET} (near/far) dan memahami \textit{return address}.
  \item Mengirim parameter dan menerima nilai balik melalui register, stack, atau memori.
  \item Memodularisasi program menjadi prosedur-prosedur yang terpisah dan teruji.
\end{itemize}

\section{Pendahuluan}
Stack adalah struktur data kritis untuk pengelolaan alur eksekusi dan data sementara. Pada 8086, stack berada pada segmen \texttt{SS} dengan penunjuk \texttt{SP}. Instruksi \texttt{PUSH}/\texttt{POP} mengubah \texttt{SP} dan menyimpan/mengambil data 16-bit (atau 8-bit dipecah) dalam urutan LIFO. Instruksi \texttt{CALL}/\texttt{RET} mengandalkan stack untuk menyimpan alamat kembali ketika berpindah ke subrutin.

\section{Materi Pembelajaran}
\subsection{Konsep Stack}
\subsubsection{Definisi dan prinsip LIFO}
Stack menyimpan item sedemikian rupa sehingga item terakhir yang dimasukkan akan diambil pertama kali. Pada 8086, stack tumbuh ke alamat lebih rendah: \texttt{PUSH} menurunkan \texttt{SP} lalu menyimpan data; \texttt{POP} mengambil data lalu menaikkan \texttt{SP}.

\subsubsection{Register SS:SP dan layout memori}
Pasangan \texttt{SS:SP} membentuk alamat efektif untuk operasi stack. Pastikan \texttt{SS} diinisialisasi benar dan \texttt{SP} memiliki ruang cukup, agar tidak menimpa data lain.

\subsubsection{Operasi stack dalam assembly}
Operasi umum: \texttt{PUSH reg/mem/flags}, \texttt{POP reg/mem}, \texttt{PUSHF}/\texttt{POPF}. Simpan register yang akan dipakai di subrutin dan kembalikan sebelum \texttt{RET}.

\subsection{Instruksi Stack}
\subsubsection{PUSH/POP register}
\begin{verbatim}
push ax
push bx
; ...
pop  bx
pop  ax
\end{verbatim}
Urutan pelepasan terbalik terhadap pemasukan.

\subsubsection{PUSH/POP memori dan immediate}
Beberapa assembler mengizinkan \texttt{PUSH word ptr [addr]} atau \texttt{PUSH imm16}. Untuk \texttt{POP} ke memori, gunakan operand memori word yang valid.

\subsubsection{PUSHF/POPF (flag register)}
\texttt{PUSHF} menyimpan FLAGS ke stack; \texttt{POPF} memulihkannya. Berguna saat memodifikasi \textit{flags} sementara.

\subsection{Instruksi Subrutin}
\subsubsection{CALL dan RET}
\texttt{CALL} (near) menyimpan \texttt{IP} ke stack dan melompat dalam segmen yang sama; \texttt{CALL FAR} menyimpan \texttt{CS:IP} untuk melompat antar segmen. \texttt{RET} memulihkan alamat kembali; \texttt{RETF} untuk far return.

\subsubsection{RET dengan parameter}
Variasi \texttt{RET n} menambah \texttt{SP} sebesar \(n\) byte setelah mengambil alamat kembali, berguna untuk membersihkan parameter stack oleh callee (konvensi \textit{pascal}-like).

\subsubsection{Penanganan return address}
Alamat kembali adalah nilai IP (dan CS untuk far) yang \texttt{CALL} dorong ke stack; jangan menimpa area ini dengan \texttt{PUSH}/\texttt{POP} tak terkendali.

\subsection{Parameter dalam Subrutin}
\subsubsection{Melalui register}
Cepat namun terbatas jumlahnya; dokumentasikan register input/output agar konsisten.

\subsubsection{Melalui stack}
Beri \texttt{PUSH} parameter sebelum \texttt{CALL}. Di dalam prosedur: \texttt{PUSH BP}; \texttt{MOV BP, SP}; akses parameter via \texttt{[BP+offset]}. Setelah selesai, \texttt{POP BP}. Pembersihan parameter oleh caller (\texttt{ADD SP, n}) atau callee (\texttt{RET n}).

\subsubsection{Melalui memori}
Sediakan blok data global/struktur; subrutin membaca/menulis langsung. Kurangi \textit{coupling} dengan mendokumentasikan kontrak data.

\subsubsection{Return value}
Letakkan pada \texttt{AX} (konvensi umum) atau tulis ke lokasi memori yang disepakati.

\subsubsection{Konvensi pemanggilan}
Sepakati skema: siapa yang menyimpan register yang dipakai (caller-saves vs callee-saves), mekanisme pembersihan parameter, dan register pengembalian.

\section{Praktikum}
\begin{enumerate}
  \item Demonstrasi \texttt{PUSH}/\texttt{POP}: dorong beberapa register dan verifikasi urutannya dengan debugger.
  \item Prosedur tanpa parameter: tampilkan string, gunakan \texttt{PUSH}/\texttt{POP} untuk menyimpan register yang dipakai.
  \item Prosedur dengan parameter via stack: jumlahkan dua bilangan 16-bit; kembalikan di \texttt{AX} dan/atau memori.
  \item Prosedur dengan return value: implementasikan \texttt{mul8(a,b)} yang mengembalikan hasil 8-bit di \texttt{AL}.
  \item Program modular: pecah menjadi beberapa prosedur (\texttt{read\_hex}, \texttt{print\_hex}, \texttt{add16}, \texttt{menu}).
\end{enumerate}

\section{Contoh Kode}
\begin{verbatim}
; Program demonstrasi stack dan subrutin
TITLE Stack dan Subrutin
.MODEL SMALL
.STACK 100h

.DATA
    pesan1 DB 'Hello from main!$'
    pesan2 DB 'Hello from subrutin!$'
    nilai1 DW 10
    nilai2 DW 20
    hasil DW ?

.CODE
START:
    MOV AX, @DATA
    MOV DS, AX
    
    ; Demonstrasi stack
    MOV AX, 1234h
    PUSH AX
    MOV BX, 5678h
    PUSH BX
    
    ; Ambil dari stack (urutan terbalik)
    POP CX  ; CX = 5678h
    POP DX  ; DX = 1234h
    
    ; Panggil subrutin
    CALL tampilkan_pesan
    
    ; Subrutin dengan parameter (via stack)
    PUSH nilai1
    PUSH nilai2
    CALL tambahkan
    ADD SP, 4  ; Bersihkan parameter dari stack (caller cleans)
    
    MOV AH, 4Ch
    INT 21h

; Subrutin tanpa parameter
TAMPILKAN_PESAN PROC
    PUSH AX
    PUSH DX
    
    MOV AH, 09h
    MOV DX, OFFSET pesan2
    INT 21h
    
    POP DX
    POP AX
    RET
TAMPILKAN_PESAN ENDP

; Subrutin dengan parameter via stack
TAMBAHKAN PROC
    PUSH BP
    MOV  BP, SP
    
    PUSH AX
    PUSH BX
    
    MOV AX, [BP+6]  ; Parameter kedua
    MOV BX, [BP+4]  ; Parameter pertama
    ADD AX, BX
    MOV hasil, AX   ; atau kembalikan di AX
    
    POP BX
    POP AX
    POP BP
    RET
TAMBAHKAN ENDP

END START
\end{verbatim}

\section{Latihan}
\begin{enumerate}
  \item Gunakan stack untuk menyimpan tiga nilai sementara; ambil kembali dalam urutan yang benar dan verifikasi.
  \item Tulis subrutin \texttt{kuadrat16(x)} yang mengembalikan \(x^2\) (perhatikan luapan). Kembalikan di \texttt{DX:AX} untuk hasil 32-bit.
  \item Tulis subrutin \texttt{swap16(a\_ptr,b\_ptr)} yang menukar dua word di memori menggunakan stack sementara.
  \item Rancang program yang memanggil beberapa subrutin secara berantai dengan parameter berbeda; pastikan stack seimbang.
\end{enumerate}

\section{Tugas}
\begin{itemize}
  \item \textbf{Subrutin aritmatika}: Implementasikan \texttt{add16}, \texttt{sub16}, \texttt{mul16}, \texttt{div16} dengan kontrak parameter/return yang jelas.
  \item \textbf{Kalkulator modular}: Antarmuka teks yang memanggil subrutin operasi berdasarkan pilihan pengguna; validasi input dan tangani kesalahan (mis. pembagi nol).
  \item \textbf{Manipulasi string}: Buat subrutin \texttt{strlen}, \texttt{strcpy}, \texttt{strcmp} sederhana untuk string berakhiran \texttt{'$'} atau \texttt{0} (pilih satu dan konsisten).
  \item \textbf{Dokumentasi}: Buat diagram stack frame untuk pemanggilan bertingkat (nested calls) dan jelaskan peran \texttt{BP}, \texttt{SP}, serta urutan penyimpanan register.
\end{itemize}

\section{Referensi}
\begin{itemize}
  \item Hyde, Randall. \textit{The Art of Assembly Language}, 2nd ed., No Starch Press, 2010.
  \item Susanto. \textit{Belajar Pemrograman Bahasa Assembly}, Elex Media Komputindo, 1995.
\end{itemize}
