\chapter{Pemrosesan File Lanjutan: Manipulasi Pointer (INT 21h fungsi 42h), Penyimpanan Data Terformat}

\section{Tujuan Pembelajaran}
Mahasiswa mampu:
\begin{itemize}
  \item Menggunakan \texttt{INT 21h, AH=42h} (LSEEK) untuk memosisikan \textit{file pointer} relatif terhadap awal, posisi kini, atau akhir.
  \item Menerapkan akses acak (random access) pada berkas dengan struktur rekaman (record) tetap/variabel.
  \item Merancang penyimpanan data terformat (record-based) lengkap dengan validasi dan pembaruan in-place.
  \item Menyusun aplikasi berkas yang modular (address book/inventory) dengan operasi CRUD.
\end{itemize}

\section{Pendahuluan}
Operasi berkas lanjutan meliputi pemindahan \textit{file pointer} untuk membaca/menulis pada posisi tertentu. Dengan \texttt{LSEEK} (\texttt{AH=42h}), program dapat mengakses bagian mana pun dari berkas secara efisien tanpa membaca dari awal. Pengorganisasian data ke dalam rekaman tetap (\textit{fixed-length}) atau variabel (\textit{variable-length}) memudahkan pengelolaan dan mempercepat pencarian serta pembaruan.

\section{Materi Pembelajaran}
\subsection{Manipulasi File Pointer}
\subsubsection{Konsep pointer dan posisi}
\textit{File pointer} adalah offset dari awal berkas yang menentukan lokasi baca/tulis berikutnya. Semua operasi baca/tulis memulai dari pointer ini dan memajukannya sesuai jumlah byte yang dioperasikan.

\subsubsection{Fungsi 42h: LSEEK}
\begin{itemize}
  \item \textbf{Masukan}: \texttt{AH=42h}, \texttt{AL=origin} (0=awal, 1=kini, 2=akhir), \texttt{BX=handle}, \texttt{CX:DX=offset 32-bit}.
  \item \textbf{Keluaran}: \texttt{DX:AX} berisi posisi baru; CF=1 saat error.
\end{itemize}
Gunakan nilai 32-bit untuk berkas besar. Hati-hati terhadap tanda (gunakan offset tak bertanda untuk maju; untuk mundur, gunakan representasi dua komplemen).

\subsubsection{Random access}
Dengan menghitung offset rekaman ke-\(i\) (mis., \(i \cdot \text{record\_size}\)) dan memanggil \texttt{LSEEK}, kita dapat langsung membaca/menulis rekaman tersebut tanpa memproses rekaman sebelumnya.

\subsection{Data Terformat}
\subsubsection{Konsep dan pilihan desain}
\begin{itemize}
  \item \textbf{Fixed-length}: setiap rekaman memiliki ukuran konstan; akses mudah via aritmetika offset.
  \item \textbf{Variable-length}: hemat ruang untuk data bervariasi; memerlukan indeks atau delimiter.
  \item \textbf{Serialization}: representasi \textit{in-memory} menjadi urutan byte yang konsisten, memperhatikan endianness dan \textit{alignment}.
\end{itemize}

\subsubsection{Record-based data}
Contoh rekaman: nama (15 byte, \textit{padded space}), umur (1 byte), gaji (2 byte, little-endian). Tentukan \texttt{record\_size} dan \texttt{schema} secara eksplisit.

\subsection{Database Sederhana}
\subsubsection{Struktur record dan indeks}
Sediakan berkas data dan opsional berkas indeks (kunci -> nomor rekaman). Operasi CRUD: buat (append), baca (seek + read), ubah (seek + write), hapus (mark as deleted atau kompaksi).

\subsubsection{File locking dan validasi}
Pada DOS single-tasking, penguncian sering tidak diperlukan, namun tetap validasikan input (panjang nama, rentang umur/gaji) dan tangani kondisi balapan pada akses bersamaan (jika ada).

\subsection{Optimasi Akses Berkas}
\subsubsection{Buffering dan caching}
Baca/tulis dalam blok yang lebih besar untuk mengurangi \textit{overhead} panggilan sistem. Cache rekaman sering diakses untuk mempercepat operasi berulang.

\subsubsection{Batch operations dan pemulihan error}
Kelompokkan pembaruan; pada error, lakukan \textit{rollback} sederhana atau catat log status untuk pemulihan manual.

\section{Praktikum}
\begin{enumerate}
  \item Demonstrasi \texttt{LSEEK}: lompat ke posisi tertentu dan tulis tanda penanda; verifikasi dengan membaca kembali.
  \item Random access: baca rekaman ke-\(n\) dan tampilkan.
  \item Data terformat: simpan beberapa rekaman tetap, lalu ubah satu rekaman di tempat (in-place update).
  \item DB sederhana: operasi CRUD pada berkas data; tampilkan daftar seluruh rekaman.
  \item Manajemen berkas: hapus (mark) rekaman lalu lakukan kompaksi untuk menghilangkan celah.
\end{enumerate}

\section{Contoh Kode}
\begin{verbatim}
; Program demonstrasi manipulasi file pointer dan data terformat (ringkas)
TITLE Pemrosesan File Lanjutan
.MODEL SMALL
.STACK 100h

.DATA
    nama_file   DB 'data.dat', 0
    file_handle DW ?

    record_size EQU 20
    ; Data contoh (fixed-length)
    data1 DB 'John Doe       ', 25, 1000
    data2 DB 'Jane Smith     ', 30, 1500
    data3 DB 'Bob Johnson    ', 35, 2000

    buffer DB record_size DUP(?)
    pesan_error DB 'Error dalam operasi!$'

.CODE
START:
    MOV AX, @DATA
    MOV DS, AX

    ; Buat dan tulis 3 rekaman
    MOV AH, 3Ch
    MOV CX, 0
    MOV DX, OFFSET nama_file
    INT 21h
    JC  error
    MOV file_handle, AX

    ; Tulis data1..data3 (masing2 record_size byte)
    MOV AH, 40h
    MOV BX, file_handle
    MOV CX, record_size
    MOV DX, OFFSET data1
    INT 21h
    JC  error
    MOV DX, OFFSET data2
    INT 21h
    JC  error
    MOV DX, OFFSET data3
    INT 21h
    JC  error

    ; Baca rekaman ke-2 via LSEEK (offset = 1*record_size)
    MOV AH, 42h
    MOV AL, 0          ; from beginning
    MOV BX, file_handle
    MOV CX, 0
    MOV DX, record_size
    INT 21h
    JC  error

    ; Baca ke buffer
    MOV AH, 3Fh
    MOV BX, file_handle
    MOV CX, record_size
    MOV DX, OFFSET buffer
    INT 21h
    JC  error

    ; Update rekaman ke-2 in-place: LSEEK mundur record_size
    MOV AH, 42h
    MOV AL, 1          ; from current
    MOV BX, file_handle
    MOV CX, 0
    MOV DX, -record_size
    INT 21h
    JC  error

    ; (Modifikasi buffer terlebih dahulu, kemudian tulis kembali)
    ; Contoh: ubah umur (offset 15) dan gaji (offset 16..17)
    MOV BYTE PTR buffer[15], 31
    MOV WORD PTR buffer[16], 1600

    ; Tulis balik
    MOV AH, 40h
    MOV BX, file_handle
    MOV CX, record_size
    MOV DX, OFFSET buffer
    INT 21h
    JC  error

    ; Tutup dan selesai
    MOV AH, 3Eh
    MOV BX, file_handle
    INT 21h
    JMP done

error:
    MOV AH, 09h
    MOV DX, OFFSET pesan_error
    INT 21h

done:
    MOV AH, 4Ch
    INT 21h
END START
\end{verbatim}

\section{Latihan}
\begin{enumerate}
  \item Baca rekaman ke-\(k\) dari berkas dan tampilkan seluruh field.
  \item Ubah field tertentu pada rekaman ke-\(k\) lalu tulis kembali (uji beberapa nilai k).
  \item Tandai rekaman sebagai terhapus (byte status) dan buat utilitas kompaksi yang menuliskan ulang hanya rekaman aktif.
  \item Tambahkan utilitas pencarian berdasarkan sebagian nama (\textit{prefix search}).
\end{enumerate}

\section{Tugas}
\begin{itemize}
  \item \textbf{Address book}: Rekaman berisi nama (padded), telepon, dan email; implementasikan CRUD lengkap dan simpan dalam berkas.
  \item \textbf{Inventory sederhana}: Rekaman berisi id, nama barang, jumlah, dan harga; dukung pembaruan stok dan laporan.
  \item \textbf{Student database}: Rekaman berisi NIM, nama, nilai; sediakan pencarian berdasarkan NIM dan penghitungan rata-rata kelas.
  \item \textbf{Optimasi}: Dokumentasikan strategi buffering dan batch write yang Anda terapkan serta pengaruhnya terhadap kinerja.
\end{itemize}

\section{Referensi}
\begin{itemize}
  \item Hyde, Randall. \textit{The Art of Assembly Language}, 2nd ed., No Starch Press, 2010.
  \item Partoharsojo, Hartono. \textit{Tuntunan Praktis Pemrograman Assembly}, Penerbit Informatika.
\end{itemize}
